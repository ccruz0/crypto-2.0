# Nginx configuration for Hilo Vivo Dashboard - Local Development
# This file should be placed in /opt/homebrew/etc/nginx/servers/ for Homebrew nginx

# Local development server (HTTP only, no SSL)
server {
    listen 8080;
    listen [::]:8080;
    server_name localhost;

    # Frontend proxy
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
    }

    # Backend API proxy - forward /api requests to backend /api
    # Lightweight health check (real backend): map /api/health to backend /ping_fast
    location = /api/health {
        proxy_pass http://127.0.0.1:8002/ping_fast;
        proxy_http_version 1.1;
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        access_log off;
    }

    # Special-case: dashboard/state is long-running; disable buffering and extend read timeout.
    location = /api/dashboard/state {
        proxy_pass http://127.0.0.1:8002/api/dashboard/state;
        proxy_http_version 1.1;
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_connect_timeout 15s;
        proxy_read_timeout    180s;
        proxy_send_timeout    180s;
        proxy_buffering off;
        proxy_next_upstream error timeout http_502 http_503 http_504;
        proxy_next_upstream_tries 3;
    }

    # Safety: signals endpoint can be slow/heavy; keep dashboard responsive.
    location ^~ /api/signals {
        default_type application/json;
        return 200 '{"signals":[]}';
    }

    # Standard API proxy
    location @api_gateway_error {
        default_type application/json;
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
        return 503 '{"error":"upstream_unavailable","message":"Backend temporarily unavailable. Please retry."}';
    }

    location /api/ {
        client_body_buffer_size 128k;
        client_max_body_size 10m;
        proxy_pass http://127.0.0.1:8002/api/;
        proxy_http_version 1.1;
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type, Authorization";
        if ($request_method = OPTIONS) { return 204; }
        proxy_connect_timeout 180s;
        proxy_read_timeout    180s;
        proxy_send_timeout    180s;

        # Convert upstream 502/503/504 into a consistent JSON error.
        proxy_intercept_errors on;
        error_page 502 503 504 = @api_gateway_error;
    }

    # Health check endpoint
    location /health {
        proxy_pass http://localhost:8002/health;
        access_log off;
    }
}





