# Full Audit & Repair Report - 2025-12-29

## Baseline Information

- **Local Commit**: `ea8e157`
- **AWS Commit**: `3c0ef03`
- **AWS Status**: All containers healthy (backend-aws, frontend-aws, market-updater-aws, db, aws-backup)
- **Audit Date**: 2025-12-29

## Executive Summary

This audit covers both documentation and code to ensure:
1. Documentation matches implementation
2. No broken or inconsistent code
3. Dashboard works end-to-end
4. Backend stability on AWS
5. All tests pass

## Documentation → Code Contract Table

| Doc Reference | Stated Behavior | Code Location | Status | Notes |
|--------------|----------------|---------------|--------|-------|
| README.md | Production uses Docker Compose with `--profile aws` | `docker-compose.yml` line 170 | ✅ VERIFIED | Uses gunicorn, not --reload |
| README.md | No --reload in production | `docker-compose.yml` line 168-170 | ✅ VERIFIED | Comment explicitly states "Prod must not use --reload" |
| README.md | AWS is ONLY live production runtime | `docker-compose.yml` profiles | ✅ VERIFIED | `--profile aws` is production |
| ALERTAS_Y_ORDENES_NORMAS.md | Throttle reset on config change | `routes_dashboard.py` lines 2052-2231 | ✅ VERIFIED | Reset logic implemented |
| ALERTAS_Y_ORDENES_NORMAS.md | Throttle reset on trade_enabled toggle | `routes_dashboard.py` lines 2100-2104 | ✅ VERIFIED | Detected and resets |
| watchlist-master-table-architecture.md | Deduplicate watchlist items | `watchlist_selector.py` | ✅ VERIFIED | `deduplicate_watchlist_items` exists |
| DASHBOARD_AUDIT.md | Setup panel exposes all strategy params | `StrategyConfigModal.tsx` | ✅ VERIFIED | All params exposed |

## Issues Found (Ranked by Severity)

### Critical (Must Fix)

1. **TODO in telegram_commands.py** (Line 1469-1470)
   - **Issue**: TODO comments for calculating realized_pnl and potential_pnl
   - **Location**: `backend/app/services/telegram_commands.py`
   - **Impact**: Low (not blocking, but incomplete)
   - **Fix**: Implement PnL calculation or document why it's deferred

2. **TODO in frontend page.tsx** (Line 4431)
   - **Issue**: TODO comment about backend save
   - **Location**: `frontend/src/app/page.tsx`
   - **Impact**: Low (may be intentional)
   - **Fix**: Verify if backend save is needed

### High Priority

3. **Alert Toggle Timeout Risk**
   - **Issue**: Alert toggle endpoints may timeout on slow database operations
   - **Location**: `routes_market.py` lines 1368-1618
   - **Status**: ⚠️ NEEDS VERIFICATION
   - **Fix**: Add explicit timeout handling and async optimization

4. **Duplicate Coin Prevention**
   - **Issue**: Frontend may show duplicates if deduplication fails
   - **Location**: `frontend/src/app/page.tsx` fetchTopCoins
   - **Status**: ✅ VERIFIED - Deduplication exists in backend
   - **Fix**: Ensure frontend uses deduplicated data

### Medium Priority

5. **Report Generation**
   - **Issue**: Reports should show runtime findings, not git errors
   - **Location**: `frontend/src/app/reports/dashboard-data-integrity/page.tsx`
   - **Status**: ✅ VERIFIED - Reports read from GitHub Actions, not git errors
   - **Fix**: None needed

6. **Signal Throttling Reset**
   - **Issue**: Must reset when Trade status toggles
   - **Location**: `routes_dashboard.py` lines 2100-2104, 2233-2384
   - **Status**: ✅ VERIFIED - Reset logic exists
   - **Fix**: None needed

### Low Priority

7. **Commented Code Blocks**
   - **Issue**: Some commented code in routes files
   - **Location**: Various
   - **Impact**: Code cleanliness
   - **Fix**: Remove if not needed

## Fixes Applied

### Fix 1: Verify Alert Toggle Timeouts
- **Status**: IN PROGRESS
- **Files**: `backend/app/api/routes_market.py`
- **Action**: Verify timeout handling is adequate

### Fix 2: Verify Duplicate Coin Prevention
- **Status**: VERIFIED
- **Files**: `backend/app/services/watchlist_selector.py`, `backend/app/api/routes_market.py`
- **Action**: Deduplication logic exists and is used

### Fix 3: Verify Production --reload Usage
- **Status**: VERIFIED
- **Files**: `docker-compose.yml`
- **Action**: Confirmed AWS profile uses gunicorn, not --reload

## Remaining Risks

1. **Alert Toggle Performance**: Need to verify endpoints respond quickly under load
2. **Frontend Duplicate Rendering**: Need to verify frontend properly handles deduplicated data
3. **Report Generation**: Already verified - reports show runtime findings

## Next Steps

1. Run tests to verify all functionality
2. Deploy fixes to AWS
3. Verify on AWS by checking logs and smoke tests
4. Create final report

