name: Deploy to AWS EC2 (Session Manager)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Fetch frontend source
      run: |
        set -e
        if [ -d "frontend/.git" ]; then
          echo "Updating existing frontend repo..."
          git -C frontend pull --ff-only
        else
          echo "Cloning frontend repo..."
          rm -rf frontend
          git clone --depth 1 https://github.com/ccruz0/frontend.git frontend
        fi
        echo "Frontend HEAD:"
        git -C frontend rev-parse HEAD
        git -C frontend log -1 --oneline

    - name: Show frontend version entry
      run: |
        set -e
        echo "Checking version entry in frontend/src/app/page.tsx"
        grep -n "version: '0.46'" frontend/src/app/page.tsx || (echo "Version 0.46 not found" && exit 1)
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-southeast-1
        
    - name: Deploy to EC2 using Session Manager
      env:
        INSTANCE_ID: i-08726dc37133b2454
      run: |
        set -e  # Exit on any error
        
        echo "üîç Deploying to instance: $INSTANCE_ID"
        
        # First, update code on EC2 using git pull
        echo "üì• Pulling latest code from git on EC2..."
        PULL_COMMAND_ID=$(aws ssm send-command \
          --instance-ids $INSTANCE_ID \
          --document-name "AWS-RunShellScript" \
          --parameters 'commands=[
            "cd ~/automated-trading-platform || cd /home/ubuntu/automated-trading-platform || { echo \"‚ùå Cannot find project directory\" && exit 1; }",
            "git pull origin main || echo \"Git pull failed, continuing...\"",
            "if [ -d frontend ]; then",
            "  echo \"Updating existing frontend repo...\"",
            "  cd frontend",
            "  git fetch origin main 2>&1 || { echo \"‚ö†Ô∏è Git fetch failed, removing and recloning...\" && cd .. && rm -rf frontend && git clone https://github.com/ccruz0/frontend.git frontend && exit 0; }",
            "  git reset --hard origin/main 2>&1 || { echo \"‚ö†Ô∏è Git reset failed, removing and recloning...\" && cd .. && rm -rf frontend && git clone https://github.com/ccruz0/frontend.git frontend && exit 0; }",
            "  cd ~/automated-trading-platform || cd /home/ubuntu/automated-trading-platform",
            "else",
            "  echo \"Frontend directory not found, cloning...\"",
            "  git clone https://github.com/ccruz0/frontend.git frontend || { echo \"‚ö†Ô∏è Clone failed\" && exit 1; }",
            "fi",
            "echo \"üîç Verifying frontend version...\"",
            "if ! grep -q \"version: '0.46'\" frontend/src/app/page.tsx; then",
            "  echo \"‚ö†Ô∏è Version 0.46 not found in frontend! Current version:\"",
            "  grep -n \"version:\" frontend/src/app/page.tsx | head -1",
            "  echo \"Frontend HEAD:\"",
            "  git -C frontend rev-parse HEAD",
            "  git -C frontend log -1 --oneline",
            "  exit 1",
            "fi",
            "echo \"‚úÖ Code updated and verified\""
          ]' \
          --region ap-southeast-1 \
          --output text \
          --query "Command.CommandId")
        
        # Wait for git pull to complete
        echo "‚è≥ Waiting for code update..."
        aws ssm wait command-executed \
          --command-id "$PULL_COMMAND_ID" \
          --instance-id $INSTANCE_ID \
          --region ap-southeast-1 || true
        
        # Get output from git pull command to verify it worked
        echo "üìÑ Git pull output:"
        aws ssm get-command-invocation \
          --command-id "$PULL_COMMAND_ID" \
          --instance-id $INSTANCE_ID \
          --region ap-southeast-1 \
          --query "StandardOutputContent" --output text || echo "Could not retrieve git pull output"
        
        # Check if git pull succeeded
        PULL_STATUS=$(aws ssm get-command-invocation \
          --command-id "$PULL_COMMAND_ID" \
          --instance-id $INSTANCE_ID \
          --region ap-southeast-1 \
          --query "Status" --output text 2>/dev/null || echo "Unknown")
        
        if [ "$PULL_STATUS" != "Success" ]; then
          echo "‚ö†Ô∏è Git pull status: $PULL_STATUS"
          echo "‚ö†Ô∏è Continuing anyway, but frontend may not be updated..."
        fi
        
        # Now rebuild and restart
        echo "üê≥ Rebuilding and restarting services..."
        
        # Execute deployment via SSM with proper JSON formatting
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids $INSTANCE_ID \
          --document-name "AWS-RunShellScript" \
          --parameters 'commands=[
            "cd ~/automated-trading-platform || cd /home/ubuntu/automated-trading-platform || { echo \"‚ùå Cannot find project directory\" && exit 1; }",
            "echo \"üìÅ Current directory: $(pwd)\"",
            "echo \"üîç Verifying frontend version before build...\"",
            "if ! grep -q \"version: '0.46'\" frontend/src/app/page.tsx; then echo \"‚ö†Ô∏è Version 0.46 not found! Current version:\" && grep -n \"version:\" frontend/src/app/page.tsx | head -1 && exit 1; fi",
            "echo \"‚úÖ Frontend version 0.46 verified\"",
            "echo \"üê≥ Rebuilding and restarting services with --profile aws...\"",
            "docker compose --profile aws down || true",
            "docker compose --profile aws build --no-cache frontend-aws",
            "docker compose --profile aws up -d --build",
            "echo \"‚è≥ Waiting for services to start...\"",
            "sleep 10",
            "echo \"‚úÖ Verifying deployment...\"",
            "docker compose --profile aws ps",
            "echo \"‚úÖ Deployment completed!\""
          ]' \
          --region ap-southeast-1 \
          --output text \
          --query "Command.CommandId")
        
        echo "üìã Command ID: $COMMAND_ID"
        
        # Wait for command to complete (with timeout)
        echo "‚è≥ Waiting for deployment to complete (this may take several minutes)..."
        for i in {1..30}; do
          STATUS=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id $INSTANCE_ID \
            --region ap-southeast-1 \
            --query "Status" --output text 2>/dev/null || echo "InProgress")
          
          if [ "$STATUS" = "Success" ] || [ "$STATUS" = "Failed" ]; then
            break
          fi
          echo "‚è≥ Still running... ($i/30)"
          sleep 10
        done
        
        # Get command output
        echo "üìÑ Deployment output:"
        aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id $INSTANCE_ID \
          --region ap-southeast-1 \
          --query "StandardOutputContent" --output text || echo "Could not retrieve output"
        
        # Check final status
        FINAL_STATUS=$(aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id $INSTANCE_ID \
          --region ap-southeast-1 \
          --query "Status" --output text 2>/dev/null || echo "Unknown")
        
        if [ "$FINAL_STATUS" = "Success" ]; then
          echo "‚úÖ Deployment completed successfully!"
        else
          echo "‚ö†Ô∏è Deployment status: $FINAL_STATUS"
          echo "Check the output above for details"
        fi
        
        echo "üéâ Deployment command sent successfully!"

