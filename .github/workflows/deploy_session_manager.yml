name: Deploy to AWS EC2 (Session Manager)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout API
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-southeast-1
        
    - name: Deploy to EC2 using Session Manager
      env:
        INSTANCE_ID: i-08726dc37133b2454
      run: |
        set -e  # Exit on any error
        
        echo "ðŸ” Deploying to instance: $INSTANCE_ID"
        
        # Create deployment script
        cat > deploy_script.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "ðŸ“ Updating code..."
        cd ~/automated-trading-platform
        
        # Pull latest changes (if using git)
        # git pull origin main
        
        echo "ðŸ³ Restarting services..."
        docker-compose down || true
        docker-compose up -d --build
        
        echo "âœ… Deployment completed!"
        EOF
        
        # Upload and execute deployment script
        echo "ðŸ“¤ Uploading deployment script..."
        aws ssm send-command \
          --instance-ids $INSTANCE_ID \
          --document-name "AWS-RunShellScript" \
          --parameters 'commands=["echo \"$DEPLOY_SCRIPT\" > /tmp/deploy.sh && chmod +x /tmp/deploy.sh && /tmp/deploy.sh"]' \
          --region ap-southeast-1
        
        echo "ðŸŽ‰ Deployment command sent successfully!"

