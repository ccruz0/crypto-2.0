name: Restart Nginx on AWS

on:
  workflow_dispatch:

jobs:
  restart-nginx:
    runs-on: ubuntu-latest
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-southeast-1
        
    - name: Restart Nginx and verify backend
      env:
        INSTANCE_ID: i-08726dc37133b2454
      run: |
        echo "üîÑ Reiniciando nginx y verificando backend..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids $INSTANCE_ID \
          --document-name "AWS-RunShellScript" \
          --parameters 'commands=[
            "echo \"üìä Verificando estado de servicios...\"",
            "docker compose --profile aws ps",
            "echo \"\"",
            "echo \"üîç Verificando backend en localhost:8002...\"",
            "curl -f --connect-timeout 5 http://localhost:8002/health || echo \"‚ö†Ô∏è Backend no responde\"",
            "echo \"\"",
            "echo \"üîÑ Reiniciando nginx...\"",
            "sudo systemctl restart nginx",
            "sleep 2",
            "echo \"\"",
            "echo \"üìä Verificando estado de nginx...\"",
            "sudo systemctl status nginx --no-pager | head -5",
            "echo \"\"",
            "echo \"üß™ Probando conectividad desde nginx al backend...\"",
            "curl -f --connect-timeout 5 http://localhost:8002/health && echo \"‚úÖ Backend accesible\" || echo \"‚ö†Ô∏è Backend no accesible\"",
            "echo \"\"",
            "echo \"üìã √öltimos errores de nginx (si hay):\"",
            "sudo tail -5 /var/log/nginx/error.log 2>/dev/null | grep -E \"502|upstream|connect\" || echo \"   No hay errores recientes\"",
            "echo \"\"",
            "echo \"‚úÖ Proceso completado!\""
          ]' \
          --region ap-southeast-1 \
          --output text \
          --query "Command.CommandId")
        
        echo "üìã Command ID: $COMMAND_ID"
        
        # Wait for command to complete
        echo "‚è≥ Esperando que complete..."
        for i in {1..20}; do
          STATUS=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id $INSTANCE_ID \
            --region ap-southeast-1 \
            --query "Status" --output text 2>/dev/null || echo "InProgress")
          
          if [ "$STATUS" = "Success" ] || [ "$STATUS" = "Failed" ]; then
            break
          fi
          echo "‚è≥ Esperando... ($i/20)"
          sleep 3
        done
        
        # Get command output
        echo "üìÑ Output:"
        aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id $INSTANCE_ID \
          --region ap-southeast-1 \
          --query "StandardOutputContent" --output text || echo "Could not retrieve output"
