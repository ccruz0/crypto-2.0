name: Deploy to AWS EC2

# ============================================
# DEPLOYMENT WORKFLOW NOTES
# ============================================
# Root Cause: The workflow was using deprecated 'docker-compose' (hyphenated) syntax
#             and missing the '--profile aws' flag required by docker-compose.yml
#
# Changes Made:
#   - Replaced 'docker-compose' with 'docker compose' (Docker Compose V2 syntax)
#   - Added '--profile aws' flag to all docker compose commands to only manage AWS profile services
#   - Updated lines 75-76: docker compose --profile aws down/up commands
#   - Updated line 81: docker compose --profile aws ps command
#
# Manual Verification:
#   ssh hilovivo-aws 'cd /home/ubuntu/automated-trading-platform && docker compose --profile aws ps'
#   ssh hilovivo-aws 'cd /home/ubuntu/automated-trading-platform && docker compose --profile aws logs -n 60 backend-aws'
#   ssh hilovivo-aws 'cd /home/ubuntu/automated-trading-platform && docker compose --profile aws logs -n 60 frontend-aws'
# ============================================

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    env:
      EC2_HOST: ${{ secrets.EC2_HOST }}
      EC2_USER: ubuntu
      EC2_KEY: ${{ secrets.EC2_KEY }}
    
    steps:
    - name: Checkout API
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        persist-credentials: true
        submodules: false  # Disable submodules since frontend is cloned manually
      
    - name: Fetch frontend source
      run: |
        set -e
        if [ -d "frontend/.git" ]; then
          echo "Updating existing frontend repo..."
          git -C frontend pull --ff-only
        else
          echo "Cloning frontend repo..."
          rm -rf frontend
          git clone --depth 1 https://github.com/ccruz0/frontend.git frontend
        fi
        echo "Frontend HEAD:"
        git -C frontend rev-parse HEAD
        git -C frontend log -1 --oneline
      
    - name: Verify checkout
      run: |
        echo "‚úÖ Repository checked out successfully"
        echo "üìÅ Current directory: $(pwd)"
        echo "üì¶ Git status:"
        git status --short || echo "‚ö†Ô∏è Git status check failed"
      
    - name: Audit trading pairs
      run: |
        python3 scripts/audit_pairs_focused.py || exit 1
      
    - name: Deploy to EC2
      run: |
        set -e  # Exit on any error
        
        # Validate required connection configuration
        if [ -z "$EC2_HOST" ]; then
          echo "‚ùå Error: EC2_HOST is not set. Add it as a repository secret or variable."
          exit 1
        fi
        if [ -z "$EC2_KEY" ]; then
          echo "‚ùå Error: EC2_KEY secret is not set."
          exit 1
        fi

        # --------------------------------------------------------------------
        # Resilient host selection (fixes SSH timeouts when the old EC2 IP changes)
        # --------------------------------------------------------------------
        # Try the configured EC2_HOST first, then fall back to known AWS hosts.
        # We test TCP port 22 directly because ping may be blocked by security groups.
        CANDIDATES=(
          "$EC2_HOST"
          "47.130.143.159"
          "175.41.189.249"
          # Legacy IPs (kept as fallback only)
          "54.254.150.31"
        )

        EC2_TARGET_HOST=""
        for H in "${CANDIDATES[@]}"; do
          if [ -z "$H" ]; then
            continue
          fi
          echo "üîç Checking SSH port 22 on: $H"
          if timeout 5 bash -c "cat < /dev/null > /dev/tcp/$H/22" 2>/dev/null; then
            EC2_TARGET_HOST="$H"
            break
          fi
        done

        if [ -z "$EC2_TARGET_HOST" ]; then
          echo "‚ùå No reachable EC2 host found on port 22."
          echo "üí° Check Security Group inbound rules for SSH (22) and the current Elastic IP."
          exit 1
        fi

        echo "‚úÖ Using EC2 host: $EC2_TARGET_HOST"
        
        echo "üîë Setting up SSH key..."
        echo "$EC2_KEY" > deploy_key.pem
        chmod 600 deploy_key.pem
        
        # Create .ssh directory if it doesn't exist and add EC2 host to known_hosts
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        ssh-keyscan -H $EC2_TARGET_HOST >> ~/.ssh/known_hosts 2>/dev/null || true
        
        echo "üì° Testing SSH connection..."
        echo "üîç Attempting to connect to: ubuntu@$EC2_TARGET_HOST"
        echo "üîç Using IP: $EC2_TARGET_HOST"
        
        # Test basic connectivity first
        echo "üåê Testing basic connectivity..."
        ping -c 3 $EC2_TARGET_HOST || echo "‚ö†Ô∏è Ping failed, but continuing with SSH test..."
        
        # Test SSH connection
        ssh -i deploy_key.pem -o StrictHostKeyChecking=no -o ConnectTimeout=30 -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@$EC2_TARGET_HOST "echo 'SSH connection successful'"
        
        if [ $? -ne 0 ]; then
          echo "‚ùå SSH connection failed. Checking common issues..."
          echo "üîç Verifying EC2 instance status..."
          echo "üí° Make sure your EC2 instance is running and has the correct security group rules"
          echo "üí° Security Group should allow SSH (port 22) from 0.0.0.0/0"
          echo "üí° Verify the EC2_HOST and EC2_KEY secrets are correct"
          exit 1
        fi
        
        # Pre-sync: Ensure destination directory exists and has correct permissions
        echo "üîß Pre-sync checks: Ensuring destination directory permissions..."
        ssh -i deploy_key.pem -o StrictHostKeyChecking=no ubuntu@$EC2_TARGET_HOST \
          "mkdir -p ~/automated-trading-platform && \
           chmod 755 ~/automated-trading-platform && \
           test -w ~/automated-trading-platform" || {
          echo "‚ùå Failed to set up destination directory permissions"
          exit 1
        }
        
        # Pre-sync: Fix permissions on existing files to allow rsync to overwrite them
        echo "üîß Pre-sync: Fixing permissions on existing files..."
        ssh -i deploy_key.pem -o StrictHostKeyChecking=no ubuntu@$EC2_TARGET_HOST \
          "cd ~/automated-trading-platform && \
           ([ -d frontend ] && find frontend -type f -exec chmod 644 {} \; 2>/dev/null || true) && \
           ([ -d frontend ] && find frontend -type d -exec chmod 755 {} \; 2>/dev/null || true) && \
           echo '‚úÖ Pre-sync permissions fixed'"
        
        echo "üìÅ Copying files to EC2..."
        # Use --partial to continue on errors, but still fail if critical files can't be copied
        rsync -avz \
          --chmod=Du=rwx,go=rx,Fu=rw,go=r \
          --partial \
          -e "ssh -i deploy_key.pem -o StrictHostKeyChecking=no" \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='.next' \
          --exclude='__pycache__' \
          --exclude='frontend/artifacts' \
          --exclude='frontend/test-results' \
          --exclude='frontend/playwright-report' \
          ./ ubuntu@$EC2_TARGET_HOST:~/automated-trading-platform/ || {
          echo "‚ö†Ô∏è rsync completed with some errors, but continuing deployment..."
        }
        
        # Post-sync: Fix permissions for Docker compatibility
        echo "üîß Post-sync: Ensuring Docker-compatible permissions..."
        ssh -i deploy_key.pem -o StrictHostKeyChecking=no ubuntu@$EC2_TARGET_HOST \
          "cd ~/automated-trading-platform && \
           find . -type d ! -perm 755 -exec chmod 755 {} \; 2>/dev/null || true && \
           find . -type f ! -perm -u+r -exec chmod u+r {} \; 2>/dev/null || true && \
           ([ -d backend ] && find backend -type d -exec chmod 755 {} \; 2>/dev/null || true) && \
           ([ -d backend ] && find backend -type f -exec chmod 644 {} \; 2>/dev/null || true) && \
           ([ -d frontend ] && find frontend -type d -exec chmod 755 {} \; 2>/dev/null || true) && \
           ([ -d frontend ] && find frontend -type f -exec chmod 644 {} \; 2>/dev/null || true) && \
           find . -type f \\( -name '*.sh' -o -name '*.bash' \\) -exec chmod +x {} \\; 2>/dev/null || true && \
           echo '‚úÖ Permissions fixed for Docker compatibility'"
        
        echo "üöÄ Running standardized deploy script..."
        # Use the standardized deploy script for consistent deployments
        ssh -i deploy_key.pem -o StrictHostKeyChecking=no ubuntu@$EC2_TARGET_HOST \
          "cd ~/automated-trading-platform && bash scripts/deploy_aws.sh" || {
          echo "‚ùå Deployment script failed"
          exit 1
        }
        
        echo "‚úÖ Verifying deployment health..."
        # Verify health/system endpoint - fail if market_updater or market_data freshness fails
        HEALTH_CHECK=$(ssh -i deploy_key.pem -o StrictHostKeyChecking=no ubuntu@$EC2_TARGET_HOST \
          "cd ~/automated-trading-platform && curl -sS http://localhost:8002/api/health/system" || echo "")
        
        if [ -z "$HEALTH_CHECK" ]; then
          echo "‚ùå Health endpoint not responding"
          exit 1
        fi
        
        # Check market_updater and market_data status (requires jq)
        if command -v jq &> /dev/null; then
          MARKET_UPDATER_STATUS=$(echo "$HEALTH_CHECK" | jq -r '.market_updater.status // "UNKNOWN"')
          MARKET_DATA_STALE=$(echo "$HEALTH_CHECK" | jq -r '.market_data.stale_symbols // "UNKNOWN"')
          
          if [ "$MARKET_UPDATER_STATUS" != "PASS" ]; then
            echo "‚ùå Market updater status is not PASS: $MARKET_UPDATER_STATUS"
            exit 1
          fi
          
          if [ "$MARKET_DATA_STALE" != "0" ] && [ "$MARKET_DATA_STALE" != "null" ]; then
            echo "‚ùå Market data has stale symbols: $MARKET_DATA_STALE"
            exit 1
          fi
          
          echo "‚úÖ Health check passed: market_updater=$MARKET_UPDATER_STATUS, stale_symbols=$MARKET_DATA_STALE"
        else
          echo "‚ö†Ô∏è  jq not available, skipping detailed health check"
        fi
        
        echo "üßπ Cleaning up..."
        rm deploy_key.pem
        
        echo "üéâ Deployment completed successfully!"


