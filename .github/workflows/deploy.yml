name: Deploy to AWS EC2

# ============================================
# DEPLOYMENT WORKFLOW NOTES
# ============================================
# Root Cause: The workflow was using deprecated 'docker-compose' (hyphenated) syntax
#             and missing the '--profile aws' flag required by docker-compose.yml
#
# Changes Made:
#   - Replaced 'docker-compose' with 'docker compose' (Docker Compose V2 syntax)
#   - Added '--profile aws' flag to all docker compose commands to only manage AWS profile services
#   - Updated lines 75-76: docker compose --profile aws down/up commands
#   - Updated line 81: docker compose --profile aws ps command
#
# Manual Verification:
#   ssh hilovivo-aws 'cd /home/ubuntu/automated-trading-platform && docker compose --profile aws ps'
#   ssh hilovivo-aws 'cd /home/ubuntu/automated-trading-platform && docker compose --profile aws logs -n 60 backend-aws'
#   ssh hilovivo-aws 'cd /home/ubuntu/automated-trading-platform && docker compose --profile aws logs -n 60 frontend-aws'
# ============================================

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      EC2_HOST: ${{ secrets.EC2_HOST }}
      EC2_USER: ubuntu
      EC2_KEY: ${{ secrets.EC2_KEY }}
    
    steps:
    - name: Checkout API
      uses: actions/checkout@v4
      
    - name: Audit trading pairs
      run: |
        python3 scripts/audit_pairs_focused.py || exit 1
      
    - name: Deploy to EC2
      run: |
        set -e  # Exit on any error
        
        # Validate required connection configuration
        if [ -z "$EC2_HOST" ]; then
          echo "âŒ Error: EC2_HOST is not set. Add it as a repository secret or variable."
          exit 1
        fi
        if [ -z "$EC2_KEY" ]; then
          echo "âŒ Error: EC2_KEY secret is not set."
          exit 1
        fi
        
        echo "ğŸ”‘ Setting up SSH key..."
        echo "$EC2_KEY" > deploy_key.pem
        chmod 600 deploy_key.pem
        
        # Add EC2 host to known_hosts
        ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts
        
        echo "ğŸ“¡ Testing SSH connection..."
        echo "ğŸ” Attempting to connect to: ubuntu@$EC2_HOST"
        echo "ğŸ” Using IP: $EC2_HOST"
        
        # Test basic connectivity first
        echo "ğŸŒ Testing basic connectivity..."
        ping -c 3 $EC2_HOST || echo "âš ï¸ Ping failed, but continuing with SSH test..."
        
        # Test SSH connection
        ssh -i deploy_key.pem -o StrictHostKeyChecking=no -o ConnectTimeout=30 -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@$EC2_HOST "echo 'SSH connection successful'"
        
        if [ $? -ne 0 ]; then
          echo "âŒ SSH connection failed. Checking common issues..."
          echo "ğŸ” Verifying EC2 instance status..."
          echo "ğŸ’¡ Make sure your EC2 instance is running and has the correct security group rules"
          echo "ğŸ’¡ Security Group should allow SSH (port 22) from 0.0.0.0/0"
          echo "ğŸ’¡ Verify the EC2_HOST and EC2_KEY secrets are correct"
          exit 1
        fi
        
        echo "ğŸ“ Copying files to EC2..."
        rsync -avz -e "ssh -i deploy_key.pem -o StrictHostKeyChecking=no" \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='.next' \
          --exclude='__pycache__' \
          ./ ubuntu@$EC2_HOST:~/automated-trading-platform/
        
        echo "ğŸ³ Restarting services..."
        # Fixed: Use docker compose (new syntax) with --profile aws flag to only manage AWS profile services
        ssh -i deploy_key.pem -o StrictHostKeyChecking=no ubuntu@$EC2_HOST \
          "cd ~/automated-trading-platform && docker compose --profile aws down && docker compose --profile aws up -d --build"
        
        echo "âœ… Verifying deployment..."
        # Fixed: Use docker compose (new syntax) with --profile aws flag
        ssh -i deploy_key.pem -o StrictHostKeyChecking=no ubuntu@$EC2_HOST \
          "cd ~/automated-trading-platform && docker compose --profile aws ps"
        
        echo "ğŸ§¹ Cleaning up..."
        rm deploy_key.pem
        
        echo "ğŸ‰ Deployment completed successfully!"


