name: Dashboard Data Integrity

on:
  push:
    branches: [main]
    paths:
      - 'frontend/**'
      - '.github/workflows/dashboard-data-integrity.yml'
  pull_request:
    branches: [main]
    paths:
      - 'frontend/**'
      - '.github/workflows/dashboard-data-integrity.yml'
  workflow_dispatch:

jobs:
  dashboard-data-integrity:
    runs-on: ubuntu-latest
    name: Dashboard Data Integrity Validation
    continue-on-error: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Checkout frontend repository
      run: |
        if [ -d "frontend/.git" ]; then
          echo "âœ… Frontend is a git repository, checking out..."
          cd frontend
          git fetch origin || echo "âš ï¸ Git fetch failed, continuing..."
          git checkout main || git checkout master || git checkout $(git branch -r | head -1 | sed 's/origin\///' | xargs) || echo "âš ï¸ Git checkout failed, continuing with current branch..."
          cd ..
        else
          echo "âš ï¸ Frontend is not a git repository, cloning..."
          rm -rf frontend
          git clone https://github.com/ccruz0/frontend.git frontend || {
            echo "âŒ Failed to clone frontend repository"
            echo "âš ï¸ This might be due to authentication. Checking if frontend directory exists..."
            if [ ! -d "frontend" ]; then
              echo "âŒ Frontend directory does not exist and clone failed. Exiting."
              exit 1
            fi
          }
        fi
        echo "âœ… Frontend checkout complete"
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Verify frontend directory
      run: |
        if [ ! -d "frontend" ]; then
          echo "âŒ frontend directory not found"
          exit 1
        fi
        echo "âœ… frontend directory exists"
        ls -la frontend/ | head -10
        if [ ! -f "frontend/package.json" ]; then
          echo "âŒ package.json not found in frontend directory"
          exit 1
        fi
        echo "âœ… package.json found"
        
    - name: Install dependencies
      working-directory: frontend
      run: |
        if [ ! -f package.json ]; then
          echo "âŒ package.json not found in frontend directory"
          exit 1
        fi
        if [ -f package-lock.json ]; then
          npm ci
        else
          npm install
        fi
      
    - name: Install Playwright browsers
      working-directory: frontend
      run: npx playwright install --with-deps
      
    - name: Run data integrity tests
      id: run_tests
      continue-on-error: true
      working-directory: frontend
      env:
        BASE_URL: ${{ secrets.DASHBOARD_URL || 'https://dashboard.hilovivo.com' }}
        DASHBOARD_URL: ${{ secrets.DASHBOARD_URL || 'https://dashboard.hilovivo.com' }}
        API_URL: ${{ secrets.API_URL || 'https://dashboard.hilovivo.com/api' }}
      run: npx playwright test tests/data-integrity --reporter=html
      
    - name: Upload Playwright report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: frontend/playwright-report/
        retention-days: 30
        
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: frontend/test-results/
        retention-days: 30
        
    - name: Upload discrepancy reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: data-integrity-reports
        path: frontend/test-results/data-integrity/*.json
        retention-days: 30
        if-no-files-found: ignore
        
    - name: Generate consolidated JSON report
      if: always()
      working-directory: frontend
      run: |
        mkdir -p reports
        node -e '
        const fs = require("fs");
        const path = require("path");
        
        const reportsDir = path.join(process.cwd(), "test-results/data-integrity");
        const outputPath = path.join(process.cwd(), "reports/dashboard-data-integrity.json");
        
        const report = {
          run: {
            workflow: "Dashboard Data Integrity",
            run_id: process.env.GITHUB_RUN_ID || "",
            created_at: new Date().toISOString(),
            commit: process.env.GITHUB_SHA || "",
            branch: process.env.GITHUB_REF_NAME || "",
            status: "PASS"
          },
          summary: {
            inconsistencies_total: 0,
            blockers: 0,
            high: 0,
            medium: 0,
            low: 0
          },
          inconsistencies: [],
          cursor_prompt: ""
        };
        
        if (fs.existsSync(reportsDir)) {
          const files = fs.readdirSync(reportsDir).filter(f => f.endsWith("-discrepancies.json"));
          
          for (const file of files) {
            const content = JSON.parse(fs.readFileSync(path.join(reportsDir, file), "utf8"));
            const tabName = content.tabName || file.replace("-discrepancies.json", "");
            
            if (content.discrepancies && Array.isArray(content.discrepancies)) {
              for (const disc of content.discrepancies) {
                const severity = disc.field === "row_missing" || disc.field === "trade_enabled" ? "high" : "medium";
                const entity = tabName === "watchlist" ? "watchlist" : 
                              tabName === "portfolio" ? "portfolio" : 
                              tabName === "monitoring" ? "alerts" : "trade";
                
                const inconsistency = {
                  id: "DI-" + String(report.inconsistencies.length + 1).padStart(3, "0"),
                  severity: severity,
                  entity: entity,
                  symbol: disc.symbol || "N/A",
                  field: disc.field,
                  dashboard_value: disc.uiValue,
                  backend_value: disc.apiValue,
                  source: {
                    api: disc.apiSourceUrl || "N/A",
                    backend_module: "app/api/routes_dashboard",
                    db: "watchlist_items" + (disc.field ? "." + disc.field : "")
                  },
                  notes: "UI shows " + JSON.stringify(disc.uiValue) + " but backend API returns " + JSON.stringify(disc.apiValue)
                };
                
                report.inconsistencies.push(inconsistency);
                
                if (severity === "high") report.summary.high++;
                else if (severity === "medium") report.summary.medium++;
                else report.summary.low++;
              }
            }
          }
        }
        
        report.summary.inconsistencies_total = report.inconsistencies.length;
        report.summary.blockers = report.inconsistencies.filter(i => i.severity === "high" && i.field === "row_missing").length;
        
        if (report.inconsistencies.length > 0) {
          report.run.status = "FAIL";
        }
        
        // Generate Cursor prompt
        if (report.inconsistencies.length > 0) {
          const inconsistenciesList = report.inconsistencies.map(i => {
            const uiVal = JSON.stringify(i.dashboard_value);
            const backendVal = JSON.stringify(i.backend_value);
            return "- " + i.id + ": " + i.entity + "/" + i.symbol + " - " + i.field + " (UI: " + uiVal + ", Backend: " + backendVal + ")";
          }).join("\\n");
          
          report.cursor_prompt = "Fix the following data inconsistencies between the Dashboard UI and backend API:\\n\\n" +
            inconsistenciesList + "\\n\\n" +
            "Requirements:\\n" +
            "1. Fix each inconsistency by aligning the backend API response or frontend rendering logic\\n" +
            "2. Add a regression test for each fixed inconsistency\\n" +
            "3. Re-run the Dashboard Data Integrity workflow to verify fixes\\n" +
            "4. Commit changes with message: \\"fix: resolve dashboard data integrity issues\\"\\n" +
            "5. Deploy after verification\\n\\n" +
            "To re-run the workflow:\\n" +
            "cd /Users/carloscruz/automated-trading-platform\\n" +
            "git push origin main";
        } else {
          report.cursor_prompt = "No inconsistencies found. Dashboard data integrity is valid.";
        }
        
        fs.writeFileSync(outputPath, JSON.stringify(report, null, 2));
        console.log("âœ… Consolidated report generated:", outputPath);
        '
        
    - name: Upload consolidated report artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: dashboard-data-integrity-report
        path: frontend/reports/dashboard-data-integrity.json
        retention-days: 30
        if-no-files-found: ignore
        
    - name: Install jq
      run: |
        sudo apt-get update
        sudo apt-get install -y jq
        
    - name: POST report to backend
      if: always()
      working-directory: frontend
      env:
        BACKEND_URL: ${{ secrets.BACKEND_URL || 'https://dashboard.hilovivo.com' }}
        REPORT_SECRET: ${{ secrets.REPORT_SECRET || 'dashboard-data-integrity-secret-2024' }}
        GITHUB_RUN_ID: ${{ github.run_id }}
      run: |
        echo "=== POSTING REPORT TO BACKEND ==="
        echo "Backend URL: ${BACKEND_URL}"
        echo "GitHub Run ID: ${GITHUB_RUN_ID}"
        echo "Current directory: $(pwd)"
        
        # Check if report file exists
        if [ ! -f "reports/dashboard-data-integrity.json" ]; then
          echo "âŒ ERROR: Report file not found at reports/dashboard-data-integrity.json"
          echo "Listing reports directory:"
          ls -la reports/ 2>&1 || echo "Reports directory does not exist"
          echo "Listing frontend directory:"
          ls -la . 2>&1 | head -20
          exit 1
        fi
        
        # Verify report file is valid JSON
        echo "Report file size: $(wc -c < reports/dashboard-data-integrity.json) bytes"
        if ! jq empty reports/dashboard-data-integrity.json 2>/dev/null; then
          echo "âŒ ERROR: Report file is not valid JSON"
          echo "First 500 chars of file:"
          head -c 500 reports/dashboard-data-integrity.json || cat reports/dashboard-data-integrity.json
          exit 1
        fi
        
        # Ensure run_id is set in the report
        echo "Updating report with GitHub Run ID..."
        if ! jq --arg run_id "${GITHUB_RUN_ID}" '.run.run_id = $run_id' reports/dashboard-data-integrity.json > /tmp/report_updated.json 2>/dev/null; then
          echo "âš ï¸ Warning: Could not update run_id with jq, using original file"
          cp reports/dashboard-data-integrity.json /tmp/report_updated.json
        else
          mv /tmp/report_updated.json reports/dashboard-data-integrity.json
        fi
        
        # Post to backend with retry logic
        MAX_RETRIES=3
        RETRY_COUNT=0
        SUCCESS=false
        
        while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = false ]; do
          RETRY_COUNT=$((RETRY_COUNT + 1))
          echo ""
          echo "ðŸ“¤ Attempt $RETRY_COUNT of $MAX_RETRIES: Posting report to backend..."
          
          HTTP_CODE=$(curl -X POST "${BACKEND_URL}/api/reports/dashboard-data-integrity" \
            -H "Content-Type: application/json" \
            -H "X-Report-Secret: ${REPORT_SECRET}" \
            -d "@reports/dashboard-data-integrity.json" \
            -w "%{http_code}" \
            -s -o /tmp/report_response.json \
            --max-time 30 \
            --connect-timeout 10 \
            --fail-with-body 2>&1 | tail -1 || echo "000")
          
          echo "HTTP Response Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            echo "âœ… Report successfully posted to backend (HTTP $HTTP_CODE)"
            if [ -f /tmp/report_response.json ]; then
              echo "Response: $(cat /tmp/report_response.json)"
            fi
            SUCCESS=true
          else
            echo "âŒ Failed to post report (HTTP $HTTP_CODE)"
            if [ -f /tmp/report_response.json ]; then
              echo "Error Response: $(cat /tmp/report_response.json)"
            fi
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "â³ Waiting 5 seconds before retry..."
              sleep 5
            fi
          fi
        done
        
        if [ "$SUCCESS" = false ]; then
          echo ""
          echo "âŒ ERROR: Failed to post report after $MAX_RETRIES attempts"
          echo "This is a critical error - the workflow will fail"
          exit 1
        fi
        
        echo ""
        echo "âœ… Report posting completed successfully!"
        
    - name: Generate report summary
      if: always()
      working-directory: frontend
      run: |
        echo "## ðŸ“Š Dashboard Data Integrity Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Count discrepancy reports
        if [ -d "test-results/data-integrity" ]; then
          REPORT_COUNT=$(find test-results/data-integrity -name "*-discrepancies.json" -type f | wc -l | tr -d ' ')
          if [ "$REPORT_COUNT" -gt 0 ]; then
            echo "âš ï¸ **$REPORT_COUNT discrepancy report(s) generated**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Discrepancy Reports" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            for report in test-results/data-integrity/*-discrepancies.json; do
              if [ -f "$report" ]; then
                TAB_NAME=$(basename "$report" | sed 's/-discrepancies.json//')
                DISCREPANCY_COUNT=$(cat "$report" | grep -o '"discrepancyCount":[0-9]*' | grep -o '[0-9]*' || echo "0")
                echo "- **$TAB_NAME**: $DISCREPANCY_COUNT discrepancies found" >> $GITHUB_STEP_SUMMARY
              fi
            done
          else
            echo "âœ… **No discrepancies found**" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Download artifacts to view:" >> $GITHUB_STEP_SUMMARY
        echo "- **Playwright HTML Report**: playwright-report/" >> $GITHUB_STEP_SUMMARY
        echo "- **Test Results**: test-results/ (includes screenshots)" >> $GITHUB_STEP_SUMMARY
        echo "- **Discrepancy Reports**: data-integrity-reports/ (JSON files)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š **View Dashboard Report:** [Open Report Page](${{ secrets.DASHBOARD_URL || 'https://dashboard.hilovivo.com' }}/reports/dashboard-data-integrity)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "After downloading artifacts:" >> $GITHUB_STEP_SUMMARY
        echo "1. Open \`playwright-report/index.html\` in browser for full test report" >> $GITHUB_STEP_SUMMARY
        echo "2. Check \`data-integrity-reports/*.json\` for detailed discrepancy data" >> $GITHUB_STEP_SUMMARY
        
    - name: Comment PR with report link
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          let comment = '## ðŸ“Š Dashboard Data Integrity Test Results\n\n';
          
          // Check for discrepancy reports
          const reportsDir = path.join(process.cwd(), 'frontend/test-results/data-integrity');
          if (fs.existsSync(reportsDir)) {
            const reports = fs.readdirSync(reportsDir)
              .filter(f => f.endsWith('-discrepancies.json'))
              .map(f => {
                const content = JSON.parse(fs.readFileSync(path.join(reportsDir, f), 'utf8'));
                return {
                  name: f.replace('-discrepancies.json', ''),
                  count: content.discrepancyCount || 0
                };
              });
            
            if (reports.length > 0) {
              comment += 'âš ï¸ **Discrepancies Detected:**\n\n';
              reports.forEach(r => {
                comment += `- **${r.name}**: ${r.count} discrepancy(ies)\n`;
              });
              comment += '\n';
            } else {
              comment += 'âœ… **No discrepancies found**\n\n';
            }
          }
          
          comment += 'ðŸ“¦ **Artifacts:** Download the workflow artifacts to view:\n';
          comment += '- Playwright HTML report\n';
          comment += '- Discrepancy JSON reports\n';
          comment += '- Screenshots (if any failures)\n\n';
          comment += `ðŸ”— **View in Actions:** ${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

